# JR運行状況通知システム - テスト計画書

## 1. 問題の概要
- **現象**: Vercel環境で `/api/jr/status` が500エラーを返し、「Unexpected end of JSON input」エラーが発生
- **原因**: Vercel環境でPuppeteerが正しく動作していない
- **影響**: 運行状況を取得できず、通知機能が動作しない

## 2. 実施した修正

### 2.1 Puppeteer設定の追加
- `puppeteer.config.cjs`: Puppeteer設定ファイルを作成
- `.puppeteerrc.cjs`: Puppeteer実行設定を追加
- Chromeのキャッシュディレクトリを明示的に指定

### 2.2 Vercelビルド設定の更新
- `vercel.json`に以下を追加:
  - `installCommand`: Puppeteerブラウザのインストールコマンド
  - 環境変数: `PUPPETEER_SKIP_CHROMIUM_DOWNLOAD`、`PUPPETEER_EXECUTABLE_PATH`

### 2.3 エラーハンドリングの強化
- `/api/jr/status/route.ts`でより詳細なエラー情報を返すように修正
- Puppeteer関連のエラーを特定して適切なメッセージを返す
- 開発環境では詳細なエラーメッセージを表示

### 2.4 Puppeteer起動オプションの改善
- Vercel環境用の実行パス設定を追加
- 環境変数`PUPPETEER_EXECUTABLE_PATH`のサポート

## 3. テスト項目

### 3.1 ローカル環境テスト（実施済み）
- ✅ Puppeteerが正しくインストールされる
- ✅ APIエンドポイントが動作する（5/6テスト合格）
- ⚠️ 手動更新ボタンのテストは時間差の問題で失敗（機能自体は動作）

### 3.2 Vercelプレビュー環境テスト
1. **デプロイメント確認**
   - [ ] ビルドが成功する
   - [ ] Puppeteerのインストールログを確認
   - [ ] 環境変数が正しく設定される

2. **API動作確認**
   - [ ] `/api/jr/status`が200を返す
   - [ ] 正しいJSON形式のレスポンスが返る
   - [ ] エラー時に適切なエラーメッセージが返る

3. **UI動作確認**
   - [ ] 運行状況が表示される
   - [ ] 自動更新が動作する
   - [ ] 手動更新ボタンが動作する

### 3.3 本番環境テスト
1. **基本動作**
   - [ ] APIが安定して動作する
   - [ ] レスポンス時間が30秒以内
   - [ ] キャッシュが正しく機能する

2. **エラー処理**
   - [ ] JRサイトがダウンしている場合の処理
   - [ ] タイムアウト時の処理
   - [ ] リトライ機能の動作

## 4. モニタリング項目
- Vercelのログでエラー発生状況を監視
- APIのレスポンスタイムを監視
- メモリ使用量を監視（Puppeteerのリーク防止）

## 5. ロールバック計画
問題が発生した場合:
1. `USE_MOCK_SCRAPER=true`を設定してモックモードに切り替え
2. 前のデプロイメントにロールバック
3. ログを分析して原因を特定

## 6. 追加の推奨事項
1. **Puppeteer-core + chrome-aws-lambda**の使用を検討
   - Vercel環境に最適化されたソリューション
   - より軽量で安定した動作

2. **外部スクレイピングサービスの検討**
   - Browserless.io
   - Puppeteer as a Service

3. **エッジケースの処理追加**
   - メモリ不足時の処理
   - ブラウザプロセスのクリーンアップ強化